<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMA TAT Analysis Tool</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --holiday-color: #e67e22;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color), var(--warning-color));
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        h1 {
            color: var(--dark-color);
            margin-bottom: 10px;
            font-size: 2.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        h1::before {
            content: 'üìä';
        }
        
        .description {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.1rem;
        }
        
        .upload-section, .holiday-section, .results-section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: var(--border-radius);
            background-color: var(--light-color);
            transition: var(--transition);
        }
        
        .upload-section:hover, .holiday-section:hover, .results-section:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: var(--dark-color);
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h3 {
            color: var(--dark-color);
            margin: 20px 0 10px 0;
            font-size: 1.2rem;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        h4 {
            color: var(--dark-color);
            margin: 10px 0;
            font-size: 1.1rem;
        }
        
        .upload-section h2::before {
            content: 'üìÅ';
        }
        
        .holiday-section h2::before {
            content: 'üìÖ';
        }
        
        .results-section h2::before {
            content: 'üìã';
        }
        
        .upload-area, .holiday-upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background-color: rgba(52, 152, 219, 0.05);
            position: relative;
        }
        
        .holiday-upload-area {
            border-color: var(--holiday-color);
            background-color: rgba(230, 126, 34, 0.05);
        }
        
        .upload-area:hover, .holiday-upload-area:hover {
            background-color: rgba(52, 152, 219, 0.1);
            transform: translateY(-3px);
        }
        
        .holiday-upload-area:hover {
            background-color: rgba(230, 126, 34, 0.1);
        }
        
        .upload-area p, .holiday-upload-area p {
            margin-bottom: 15px;
            color: var(--dark-color);
            font-size: 1.1rem;
        }
        
        .file-input, .holiday-file-input {
            display: none;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-holiday {
            background-color: var(--holiday-color);
        }
        
        .btn-holiday:hover {
            background-color: #d35400;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .holiday-list-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
        }
        
        .holiday-item {
            display: inline-block;
            padding: 5px 10px;
            margin: 3px;
            background-color: rgba(230, 126, 34, 0.1);
            border: 1px solid var(--holiday-color);
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--holiday-color);
        }
        
        .detailed-table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }
        
        th, td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .status-message {
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 500;
        }
        
        .success {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .error {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }
        
        .warning {
            background-color: rgba(243, 156, 18, 0.15);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }
        
        .hidden {
            display: none;
        }
        
        .summary-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--box-shadow);
        }
        
        .summary-card h3 {
            color: var(--dark-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: none;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .within-tat {
            color: var(--success-color);
        }
        
        .out-tat {
            color: var(--danger-color);
        }
        
        .info-box {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 12px 16px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .holiday-info-box {
            background-color: rgba(230, 126, 34, 0.1);
            border-left: 4px solid var(--holiday-color);
            padding: 12px 16px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .tat-rules {
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--success-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .tat-rules h3 {
            margin-bottom: 10px;
            color: var(--success-color);
            border-bottom: none;
        }
        
        .tat-rules ul {
            margin-left: 20px;
        }
        
        .tat-rules li {
            margin-bottom: 5px;
        }
        
        .product-category-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .category-tab {
            padding: 10px 20px;
            background: #e0e0e0;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .category-tab:hover {
            background: #d0d0d0;
        }
        
        .category-tab.active {
            background: var(--primary-color);
            color: white;
        }
        
        .category-content {
            display: none;
        }
        
        .category-content.active {
            display: block;
        }
        
        .commercial-indicator {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #9b59b6;
            padding: 12px 16px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .commercial-indicator strong {
            color: #9b59b6;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .summary-box {
                grid-template-columns: 1fr;
            }
            
            .product-category-tabs {
                flex-direction: column;
            }
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #777;
            font-size: 0.9rem;
        }
        
        .shipping-format-note {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 4px solid var(--warning-color);
            padding: 12px 16px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .summary-table {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .summary-table th {
            background-color: var(--dark-color);
        }
        
        .commercial-highlight {
            background-color: rgba(155, 89, 182, 0.1) !important;
        }
        
        .holiday-highlight {
            background-color: rgba(230, 126, 34, 0.05) !important;
        }
        
        .rules-box {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .rules-column {
            padding: 15px;
            border-radius: var(--border-radius);
            background: var(--light-color);
        }
        
        .rules-column h4 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }
        
        @media (max-width: 768px) {
            .rules-box {
                grid-template-columns: 1fr;
            }
        }
        
        .important-note {
            background-color: rgba(243, 156, 18, 0.15);
            border-left: 4px solid var(--warning-color);
            padding: 12px 16px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .timezone-note {
            background-color: rgba(52, 152, 219, 0.15);
            border-left: 4px solid var(--primary-color);
            padding: 12px 16px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .timezone-note strong {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>RMA TAT Analysis Tool</h1>
            <p class="description">Upload your Excel file with RMA data to analyze if calls were shipped Within-TAT or Out-TAT. Upload holiday calendar to exclude holidays from TAT calculation.</p>
        </header>
        
        <section class="upload-section">
            <h2>Step 1: Upload RMA Data File</h2>
            <div class="info-box">
                <strong>Required Columns:</strong> The file must contain RMA_CENTER, RMA_NO, RMA_SHIPPING_TYPE_DESC, RMA_SERIAL_NO, RMA_REPAIR_SOLUTION_MEMO, RMA_ISSUE_DATE, RMA_SHIP_DATE, RMA_CLOSED_DATE, and RMA_PRODUCT_TYPE_DESC.
            </div>
            <div class="timezone-note">
                <strong>‚ö†Ô∏è TIMEZONE CONVERSION:</strong> All dates are automatically converted from Taiwan time (UTC+8) to India time (UTC+5:30) for accurate TAT calculation.
            </div>
            <div class="upload-area" id="uploadArea">
                <p>Drag & drop your RMA data file here or click to browse</p>
                <p>Supported formats: .csv, .xlsx, .xls</p>
                <button class="btn" id="browseBtn">
                    <span>üìÇ</span> Browse Files
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls">
            </div>
            <div id="uploadStatus" class="status-message hidden"></div>
        </section>
        
        <section class="holiday-section" id="holidaySection">
            <h2>Step 2: Upload Holiday Calendar (Optional)</h2>
            <div class="holiday-info-box">
                <strong>üìÖ Holiday Exclusion:</strong> Upload holidays in DD/MM/YYYY format. Supported formats: .txt (one date per line), .csv, .xlsx, .xls. Holidays will be excluded from TAT calculation (not counted as workdays).
            </div>
            <div class="holiday-upload-area" id="holidayUploadArea">
                <p>Drag & drop your holiday calendar file here or click to browse</p>
                <p>Supported formats: .txt, .csv, .xlsx, .xls (DD/MM/YYYY format)</p>
                <button class="btn btn-holiday" id="browseHolidayBtn">
                    <span>üìÖ</span> Browse Holiday File
                </button>
                <input type="file" id="holidayFileInput" class="holiday-file-input" accept=".txt,.csv,.xlsx,.xls">
            </div>
            <div id="holidayStatus" class="status-message hidden"></div>
            <div id="holidayListContainer" class="holiday-list-container" style="display: none;">
                <strong>Loaded Holidays:</strong>
                <div id="holidayList"></div>
            </div>
            <div class="actions">
                <button class="btn btn-danger" id="clearHolidayBtn">
                    <span>üóëÔ∏è</span> Clear Holidays
                </button>
            </div>
        </section>
        
        <section class="results-section" id="resultsSection" style="display: none;">
            <h2>Step 3: Analysis Results</h2>
            
            <div class="tat-rules">
                <h3>üìã TAT Rules Applied:</h3>
                <div class="rules-box">
                    <div class="rules-column">
                        <h4>Consumer Products:</h4>
                        <ul>
                            <li><strong>Special RMA Centers:</strong> RRL_BDN, RRL_GOA, RRL_KOT, RRL_MUZ, RRL_MAN, RRL_MDP, RRL_SLM, RRL_TVL</li>
                            <li>On site = 7 days, Carry In/Out = 5 days</li>
                            <li><strong>Other Centers:</strong> On site = 5 days, Carry In/Out = 3 days</li>
                        </ul>
                    </div>
                    <div class="rules-column">
                        <h4>Commercial Products:</h4>
                        <ul>
                            <li><strong>Special RMA Centers:</strong> RRL_BDN, RRL_GOA, RRL_KOT, RRL_MUZ, RRL_MAN, RRL_MDP, RRL_SLM, RRL_TVL</li>
                            <li>On site = 5 days, Carry In/Out = 3 days</li>
                            <li><strong>Other Centers:</strong> Both On site & Carry In/Out = 3 days</li>
                        </ul>
                    </div>
                </div>
                <ul>
                    <li><strong>Timezone Conversion:</strong> All dates converted from Taiwan (UTC+8) to India (UTC+5:30) time</li>
                    <li><strong>Holiday Exclusion:</strong> User-defined holidays are excluded from TAT calculation (not counted as workdays)</li>
                    <li><strong>Weekend Exclusion:</strong> Saturdays and Sundays NEVER included in TAT</li>
                    <li><strong>Friday/Saturday Calls:</strong> Day 1 starts from following Monday</li>
                    <li><strong>TAT Calculation:</strong> Compares RMA_SHIP_DATE (India time) with SLA_CUT_OFF date</li>
                    <li><strong>Display Includes:</strong> RMA_CLOSED_DATE for reference</li>
                </ul>
            </div>
            
            <div id="holidaySummary" class="holiday-info-box" style="display: none;">
                <strong>üìÖ Holiday Calendar Active:</strong> <span id="holidayCount"></span> holidays loaded and excluded from TAT calculation.
            </div>
            
            <div class="summary-box" id="overallSummary">
                <!-- Overall summary cards will be populated dynamically -->
            </div>
            
            <div class="product-category-tabs">
                <div class="category-tab active" data-category="overall">Overall</div>
                <div class="category-tab" data-category="consumer">Consumer</div>
                <div class="category-tab" data-category="commercial">Commercial</div>
            </div>
            
            <div id="overallContent" class="category-content active">
                <h3>Overall TAT Analysis by RMA Center</h3>
                <div class="summary-table">
                    <table id="overallTable">
                        <thead>
                            <tr>
                                <th>Row Labels</th>
                                <th>Out-TAT</th>
                                <th>Within-TAT</th>
                                <th>Grand Total</th>
                                <th>% Within-TAT</th>
                            </tr>
                        </thead>
                        <tbody id="overallTableBody">
                            <!-- Overall table rows will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <h3>Detailed RMA Data (Overall)</h3>
                <div class="detailed-table-container">
                    <table id="overallDetailedTable">
                        <thead id="overallDetailedHeader">
                            <!-- Detailed table headers will be populated dynamically -->
                        </thead>
                        <tbody id="overallDetailedBody">
                            <!-- Detailed table rows will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="consumerContent" class="category-content">
                <h3>Consumer Products TAT Analysis by RMA Center</h3>
                <div class="summary-table">
                    <table id="consumerTable">
                        <thead>
                            <tr>
                                <th>Row Labels</th>
                                <th>Out-TAT</th>
                                <th>Within-TAT</th>
                                <th>Grand Total</th>
                                <th>% Within-TAT</th>
                            </tr>
                        </thead>
                        <tbody id="consumerTableBody">
                            <!-- Consumer table rows will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <h3>Detailed RMA Data (Consumer)</h3>
                <div class="detailed-table-container">
                    <table id="consumerDetailedTable">
                        <thead id="consumerDetailedHeader">
                            <!-- Detailed table headers will be populated dynamically -->
                        </thead>
                        <tbody id="consumerDetailedBody">
                            <!-- Detailed table rows will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="commercialContent" class="category-content">
                <h3>Commercial Products TAT Analysis by RMA Center</h3>
                <div class="summary-table">
                    <table id="commercialTable">
                        <thead>
                            <tr>
                                <th>Row Labels</th>
                                <th>Out-TAT</th>
                                <th>Within-TAT</th>
                                <th>Grand Total</th>
                                <th>% Within-TAT</th>
                            </tr>
                        </thead>
                        <tbody id="commercialTableBody">
                            <!-- Commercial table rows will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <h3>Detailed RMA Data (Commercial)</h3>
                <div class="detailed-table-container">
                    <table id="commercialDetailedTable">
                        <thead id="commercialDetailedHeader">
                            <!-- Detailed table headers will be populated dynamically -->
                        </thead>
                        <tbody id="commercialDetailedBody">
                            <!-- Detailed table rows will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn btn-success" id="exportCsvBtn">
                    <span>üì•</span> Export All as CSV
                </button>
                <button class="btn btn-success" id="exportXlsxBtn">
                    <span>üìä</span> Export All as Excel
                </button>
                <button class="btn btn-warning" id="resetBtn">
                    <span>üîÑ</span> Reset
                </button>
            </div>
            
            <div class="export-options">
                <button class="btn" id="exportOverallCsvBtn">
                    <span>üì•</span> Export Overall CSV
                </button>
                <button class="btn" id="exportConsumerCsvBtn">
                    <span>üì•</span> Export Consumer CSV
                </button>
                <button class="btn" id="exportCommercialCsvBtn">
                    <span>üì•</span> Export Commercial CSV
                </button>
            </div>
        </section>
        
        <div class="footer">
            <p>RMA TAT Analysis Tool v2.1 - With Holiday Calendar & RMA_CLOSED_DATE</p>
        </div>
    </div>

    <script>
        // Global variables
        let uploadedData = [];
        let processedData = [];
        let consumerData = [];
        let commercialData = [];
        let holidays = new Set(); // Store holidays as string keys
        
        const requiredColumns = [
            'RMA_CENTER', 'RMA_NO', 'RMA_SHIPPING_TYPE_DESC', 'RMA_SERIAL_NO',
            'RMA_REPAIR_SOLUTION_MEMO', 'RMA_ISSUE_DATE', 'RMA_SHIP_DATE', 
            'RMA_CLOSED_DATE', 'RMA_PRODUCT_TYPE_DESC'
        ];
        
        // Special RMA centers with extended TAT
        const specialRmaCenters = ["RRL_BDN", "RRL_GOA", "RRL_KOT", "RRL_MUZ", "RRL_MAN", "RRL_MDP", "RRL_SLM", "RRL_TVL"];

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        
        const holidayUploadArea = document.getElementById('holidayUploadArea');
        const holidayFileInput = document.getElementById('holidayFileInput');
        const browseHolidayBtn = document.getElementById('browseHolidayBtn');
        const holidayStatus = document.getElementById('holidayStatus');
        const holidayListContainer = document.getElementById('holidayListContainer');
        const holidayList = document.getElementById('holidayList');
        const clearHolidayBtn = document.getElementById('clearHolidayBtn');
        const holidaySummary = document.getElementById('holidaySummary');
        const holidayCount = document.getElementById('holidayCount');
        
        const resultsSection = document.getElementById('resultsSection');
        const overallSummary = document.getElementById('overallSummary');
        
        // Tab elements
        const categoryTabs = document.querySelectorAll('.category-tab');
        const categoryContents = document.querySelectorAll('.category-content');
        
        // Export buttons
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportXlsxBtn = document.getElementById('exportXlsxBtn');
        const exportOverallCsvBtn = document.getElementById('exportOverallCsvBtn');
        const exportConsumerCsvBtn = document.getElementById('exportConsumerCsvBtn');
        const exportCommercialCsvBtn = document.getElementById('exportCommercialCsvBtn');
        const resetBtn = document.getElementById('resetBtn');

        // Event listeners
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.2)';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload();
            }
        });
        
        // Holiday file listeners
        browseHolidayBtn.addEventListener('click', () => holidayFileInput.click());
        holidayFileInput.addEventListener('change', handleHolidayUpload);
        holidayUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            holidayUploadArea.style.backgroundColor = 'rgba(230, 126, 34, 0.2)';
        });
        holidayUploadArea.addEventListener('dragleave', () => {
            holidayUploadArea.style.backgroundColor = 'rgba(230, 126, 34, 0.05)';
        });
        holidayUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            holidayUploadArea.style.backgroundColor = 'rgba(230, 126, 34, 0.05)';
            if (e.dataTransfer.files.length) {
                holidayFileInput.files = e.dataTransfer.files;
                handleHolidayUpload();
            }
        });
        
        clearHolidayBtn.addEventListener('click', clearHolidays);
        
        // Tab switching
        categoryTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const category = tab.getAttribute('data-category');
                
                // Update active tab
                categoryTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding content
                categoryContents.forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${category}Content`).classList.add('active');
            });
        });
        
        // Export listeners
        exportCsvBtn.addEventListener('click', exportAllToCsv);
        exportXlsxBtn.addEventListener('click', exportAllToXlsx);
        exportOverallCsvBtn.addEventListener('click', () => exportCategoryToCsv('overall'));
        exportConsumerCsvBtn.addEventListener('click', () => exportCategoryToCsv('consumer'));
        exportCommercialCsvBtn.addEventListener('click', () => exportCategoryToCsv('commercial'));
        resetBtn.addEventListener('click', resetApp);

        // Parse holiday date from various formats
        function parseHolidayDate(dateStr) {
            if (!dateStr) return null;
            
            // If it's already a Date object
            if (dateStr instanceof Date) {
                return dateStr;
            }
            
            // If it's a number (Excel serial date)
            if (typeof dateStr === 'number' && dateStr > 0) {
                // Excel's epoch starts from January 1, 1900
                const excelEpoch = new Date(1900, 0, 1);
                // Adjust for Excel's leap year bug (it considers 1900 as a leap year)
                const days = dateStr - (dateStr > 60 ? 2 : 1);
                return new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
            }
            
            // Convert to string and clean
            const dateString = dateStr.toString().trim();
            if (dateString.length === 0) return null;
            
            // If it's a digits-only string (likely Excel serial date), handle like numeric serial
            if (/^\d+(\.\d+)?$/.test(dateString)) {
                const serial = parseFloat(dateString);
                if (serial > 0) {
                    const excelEpoch = new Date(1900, 0, 1);
                    const days = serial - (serial > 60 ? 2 : 1);
                    return new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
                }
            }
            
            // Try DD/MM/YYYY format first (Indian format)
            const dmyMatch = dateString.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
            if (dmyMatch) {
                const day = parseInt(dmyMatch[1]);
                const month = parseInt(dmyMatch[2]) - 1;
                const year = parseInt(dmyMatch[3]);
                
                // Validate day/month range
                if (day >= 1 && day <= 31 && month >= 0 && month <= 11) {
                    const date = new Date(year, month, day);
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                }
            }
            
            // Try MM/DD/YYYY format (US format)
            const mdyMatch = dateString.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
            if (mdyMatch) {
                const month = parseInt(mdyMatch[1]) - 1;
                const day = parseInt(mdyMatch[2]);
                const year = parseInt(mdyMatch[3]);
                
                if (day >= 1 && day <= 31 && month >= 0 && month <= 11) {
                    const date = new Date(year, month, day);
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                }
            }
            
            // Try YYYY-MM-DD format
            const ymdMatch = dateString.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
            if (ymdMatch) {
                const year = parseInt(ymdMatch[1]);
                const month = parseInt(ymdMatch[2]) - 1;
                const day = parseInt(ymdMatch[3]);
                const date = new Date(year, month, day);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }
            
            // Try DD.MM.YYYY format
            const dmyDotMatch = dateString.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
            if (dmyDotMatch) {
                const day = parseInt(dmyDotMatch[1]);
                const month = parseInt(dmyDotMatch[2]) - 1;
                const year = parseInt(dmyDotMatch[3]);
                const date = new Date(year, month, day);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }
            
            // Try native Date parsing as last resort
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            } catch (e) {
                // Ignore
            }
            
            return null;
        }

        // Handle holiday file upload
        function handleHolidayUpload() {
            const file = holidayFileInput.files[0];
            if (!file) return;
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!['txt', 'csv', 'xlsx', 'xls'].includes(fileExtension)) {
                showHolidayStatus('Please upload a valid file format.', 'error');
                return;
            }
            
            showHolidayStatus('Processing holiday calendar...', 'success');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let holidayDates = [];
                    
                    if (fileExtension === 'txt') {
                        // Parse text file - one date per line
                        const content = e.target.result;
                        holidayDates = content.split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0);
                    } else {
                        // Parse Excel/CSV file
                        const data = new Uint8Array(e.target.result);
                        let workbook;
                        
                        if (fileExtension === 'csv') {
                            const csvString = new TextDecoder().decode(data);
                            workbook = XLSX.read(csvString, { type: 'string' });
                        } else {
                            workbook = XLSX.read(data, { type: 'array' });
                        }
                        
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Extract first column from each row, skipping header if it looks like a header
                        holidayDates = jsonData
                            .map(row => row[0])
                            .filter(cell => {
                                if (!cell) return false;
                                const cellStr = cell.toString().trim();
                                // Skip if it looks like a column header
                                if (cellStr.toLowerCase().includes('date') || 
                                    cellStr.toLowerCase().includes('holiday') ||
                                    cellStr.toLowerCase().includes('day')) {
                                    return false;
                                }
                                return cellStr.length > 0;
                            })
                            .map(cell => cell.toString().trim());
                    }
                    
                    if (holidayDates.length === 0) {
                        showHolidayStatus('No dates found in the file.', 'error');
                        return;
                    }
                    
                    // Parse and validate dates
                    const validHolidays = new Set();
                    const invalidDates = [];
                    
                    holidayDates.forEach(dateStr => {
                        const parsedDate = parseHolidayDate(dateStr);
                        if (parsedDate) {
                            // Store as DD/MM/YYYY format
                            const day = parsedDate.getDate().toString().padStart(2, '0');
                            const month = (parsedDate.getMonth() + 1).toString().padStart(2, '0');
                            const year = parsedDate.getFullYear();
                            validHolidays.add(`${day}/${month}/${year}`);
                        } else {
                            invalidDates.push(dateStr);
                        }
                    });
                    
                    if (validHolidays.size === 0) {
                        let errorMsg = 'No valid dates found in the file.';
                        if (invalidDates.length > 0) {
                            errorMsg += ` Invalid formats: ${invalidDates.slice(0, 5).join(', ')}${invalidDates.length > 5 ? '...' : ''}`;
                        }
                        showHolidayStatus(errorMsg, 'error');
                        return;
                    }
                    
                    // Merge with existing holidays
                    validHolidays.forEach(date => holidays.add(date));
                    
                    displayHolidayList();
                    showHolidayStatus(`Successfully loaded ${validHolidays.size} holidays. ${invalidDates.length > 0 ? `(${invalidDates.length} invalid dates skipped)` : ''}`, 'success');
                    
                    // If data is already processed, recalculate with new holidays
                    if (processedData.length > 0) {
                        recalculateWithHolidays();
                    }
                    
                } catch (error) {
                    console.error('Error processing holiday file:', error);
                    showHolidayStatus('Error processing holiday file. Please check the format.', 'error');
                }
            };
            
            if (fileExtension === 'txt' || fileExtension === 'csv') {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // Display holiday list
        function displayHolidayList() {
            if (holidays.size > 0) {
                const sortedHolidays = Array.from(holidays).sort((a, b) => {
                    const [d1, m1, y1] = a.split('/').map(Number);
                    const [d2, m2, y2] = b.split('/').map(Number);
                    return new Date(y1, m1 - 1, d1) - new Date(y2, m2 - 1, d2);
                });
                
                holidayList.innerHTML = sortedHolidays.map(date => 
                    `<span class="holiday-item">${date}</span>`
                ).join('');
                
                holidayListContainer.style.display = 'block';
                holidaySummary.style.display = 'block';
                holidayCount.textContent = holidays.size;
            } else {
                holidayListContainer.style.display = 'none';
                holidaySummary.style.display = 'none';
            }
        }

        // Clear all holidays
        function clearHolidays() {
            holidays.clear();
            displayHolidayList();
            showHolidayStatus('Holiday calendar cleared.', 'success');
            
            if (processedData.length > 0) {
                recalculateWithHolidays();
            }
        }

        // Show holiday status message
        function showHolidayStatus(message, type) {
            holidayStatus.textContent = message;
            holidayStatus.className = `status-message ${type}`;
            holidayStatus.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    holidayStatus.classList.add('hidden');
                }, 5000);
            }
        }

        // Recalculate TAT with updated holidays
        function recalculateWithHolidays() {
            showStatus('Recalculating TAT with holiday calendar...', 'success');
            
            // Recalculate SLA_CUT_OFF and TAT_STATUS for all rows
            processedData = processedData.map(row => {
                const slaCutOff = calculateSlaCutOff(
                    row.RMA_ISSUE_DATE, 
                    row.RMA_CENTER, 
                    row.RMA_SHIPPING_TYPE_DESC,
                    row.PRODUCT_CATEGORY
                );
                
                const tatStatus = calculateTatStatus(
                    row.RMA_SHIP_DATE, 
                    slaCutOff
                );
                
                return {
                    ...row,
                    SLA_CUT_OFF: slaCutOff,
                    TAT_STATUS: tatStatus
                };
            });
            
            // Split data into Consumer and Commercial categories
            consumerData = processedData.filter(row => row.PRODUCT_CATEGORY === 'Consumer');
            commercialData = processedData.filter(row => row.PRODUCT_CATEGORY === 'Commercial');
            
            displayResults();
        }

        // Handle file upload
        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!['csv', 'xlsx', 'xls'].includes(fileExtension)) {
                showStatus('Please upload a valid CSV or Excel file.', 'error');
                return;
            }
            
            showStatus('Processing file with timezone conversion...', 'success');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    let workbook;
                    
                    if (fileExtension === 'csv') {
                        const csvString = new TextDecoder().decode(data);
                        workbook = XLSX.read(csvString, { type: 'string' });
                    } else {
                        workbook = XLSX.read(data, { type: 'array' });
                    }
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    uploadedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (uploadedData.length < 2) {
                        showStatus('The uploaded file appears to be empty or has no data.', 'error');
                        return;
                    }
                    
                    const headers = uploadedData[0];
                    
                    // Check for required columns
                    const missingColumns = requiredColumns.filter(col => 
                        !headers.some(header => header.trim().toUpperCase() === col)
                    );
                    
                    if (missingColumns.length > 0) {
                        showStatus(`Missing required columns: ${missingColumns.join(', ')}`, 'error');
                        return;
                    }
                    
                    // Process data
                    const processedRows = uploadedData.slice(1).map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            const normalizedHeader = header.trim().toUpperCase();
                            obj[normalizedHeader] = convertExcelDate(row[index]) || row[index] || '';
                        });
                        return obj;
                    });
                    
                    // Remove duplicate RMA entries based on RMA_NO
                    const uniqueRmas = removeDuplicates(processedRows);
                    
                    // Calculate SLA_CUT_OFF and TAT_STATUS for all rows
                    processedData = uniqueRmas.map(row => {
                        const productCategory = determineProductCategory(row.RMA_PRODUCT_TYPE_DESC);
                        
                        const slaCutOff = calculateSlaCutOff(
                            row.RMA_ISSUE_DATE, 
                            row.RMA_CENTER, 
                            row.RMA_SHIPPING_TYPE_DESC,
                            productCategory
                        );
                        
                        const tatStatus = calculateTatStatus(
                            row.RMA_SHIP_DATE, 
                            slaCutOff
                        );
                        
                        return {
                            ...row,
                            SLA_CUT_OFF: slaCutOff,
                            TAT_STATUS: tatStatus,
                            PRODUCT_CATEGORY: productCategory,
                            ORIGINAL_ISSUE_DATE: row.RMA_ISSUE_DATE,
                            ORIGINAL_SHIP_DATE: row.RMA_SHIP_DATE,
                            ORIGINAL_CLOSED_DATE: row.RMA_CLOSED_DATE,
                            ISSUE_DATE_INDIA: convertTaiwanToIndiaFormatted(row.RMA_ISSUE_DATE),
                            SHIP_DATE_INDIA: convertTaiwanToIndiaFormatted(row.RMA_SHIP_DATE),
                            CLOSED_DATE_INDIA: convertTaiwanToIndiaFormatted(row.RMA_CLOSED_DATE)
                        };
                    });
                    
                    // Split data into Consumer and Commercial categories
                    consumerData = processedData.filter(row => row.PRODUCT_CATEGORY === 'Consumer');
                    commercialData = processedData.filter(row => row.PRODUCT_CATEGORY === 'Commercial');
                    
                    showStatus('File processed successfully!', 'success');
                    displayResults();
                    resultsSection.style.display = 'block';
                    
                } catch (error) {
                    console.error('Error processing file:', error);
                    showStatus('Error processing file. Please try again.', 'error');
                }
            };
            
            if (fileExtension === 'csv') {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // Determine product category from RMA_PRODUCT_TYPE_DESC
        function determineProductCategory(productTypeDesc) {
            if (!productTypeDesc) return 'Consumer';
            
            const productTypeStr = productTypeDesc.toString().toUpperCase();
            
            if (productTypeStr.includes('(COMMERCIAL)') || productTypeStr.includes('COMMERCIAL')) {
                return 'Commercial';
            }
            
            return 'Consumer';
        }

        // Convert Excel serial date to readable format
        function convertExcelDate(serial) {
            if (typeof serial === 'number' && serial > 0) {
                const excelEpoch = new Date(1900, 0, 1);
                const days = serial - (serial > 60 ? 2 : 1);
                const date = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
                
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                
                const formattedTime = date.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
                
                return `${formattedDate} ${formattedTime}`;
            }
            
            return serial;
        }

        // Convert Taiwan time to India time
        function convertTaiwanToIndia(taiwanDate) {
            if (!taiwanDate) return null;
            
            const dateObj = parseDateString(taiwanDate);
            if (!dateObj || isNaN(dateObj.getTime())) return null;
            
            const indiaTime = new Date(dateObj.getTime() - (2.5 * 60 * 60 * 1000));
            
            return indiaTime;
        }

        // Convert Taiwan time to India time and format it
        function convertTaiwanToIndiaFormatted(taiwanDate) {
            const indiaDate = convertTaiwanToIndia(taiwanDate);
            if (!indiaDate) return '';
            return formatDate(indiaDate);
        }

        // Parse date string
        function parseDateString(dateString) {
            if (!dateString) return null;
            
            if (dateString instanceof Date) return dateString;
            
            if (typeof dateString === 'number' && dateString > 0) {
                return new Date((dateString - 25569) * 86400 * 1000);
            }
            
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) return date;
            
            const parts = dateString.split(' ');
            if (parts.length >= 2) {
                const datePart = parts[0];
                const timePart = parts[1] + (parts[2] ? ' ' + parts[2] : '');
                
                const dateParts = datePart.split('/');
                if (dateParts.length === 3) {
                    const month = parseInt(dateParts[0]) - 1;
                    const day = parseInt(dateParts[1]);
                    const year = parseInt(dateParts[2]);
                    
                    const timeParts = timePart.split(':');
                    if (timeParts.length >= 2) {
                        let hours = parseInt(timeParts[0]);
                        const minutes = parseInt(timeParts[1]);
                        const seconds = timeParts[2] ? parseInt(timeParts[2]) : 0;
                        
                        if (timePart.toLowerCase().includes('pm') && hours < 12) {
                            hours += 12;
                        } else if (timePart.toLowerCase().includes('am') && hours === 12) {
                            hours = 0;
                        }
                        
                        return new Date(year, month, day, hours, minutes, seconds);
                    }
                }
            }
            
            return null;
        }

        // Remove duplicate RMA entries based on RMA_NO
        function removeDuplicates(data) {
            const uniqueMap = new Map();
            
            data.forEach(row => {
                const rmaNo = row.RMA_NO || '';
                if (rmaNo && !uniqueMap.has(rmaNo)) {
                    uniqueMap.set(rmaNo, row);
                }
            });
            
            return Array.from(uniqueMap.values());
        }

        // Parse shipping type
        function parseShippingType(shippingType) {
            if (!shippingType) return '';
            
            const shippingStr = shippingType.toString();
            
            if (shippingStr.includes('On site') || 
                shippingStr.includes('On-site') ||
                shippingStr.includes('OnSite') ||
                shippingStr.toLowerCase().includes('onsite')) {
                return 'On site';
            }
            
            if (shippingStr.includes('Carry In/Out') ||
                shippingStr.includes('Carry In') ||
                shippingStr.includes('Carry Out') ||
                shippingStr.includes('Carry-in') ||
                shippingStr.includes('Carry-out')) {
                return 'Carry In/Out';
            }
            
            return shippingStr;
        }

        // Check if a date is a holiday
        function isHoliday(date) {
            if (!date || holidays.size === 0) return false;
            
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const dateKey = `${day}/${month}/${year}`;
            
            return holidays.has(dateKey);
        }

        // Check if a date is a working day (not weekend and not holiday)
        function isWorkingDay(date) {
            const dayOfWeek = date.getDay();
            // 0 = Sunday, 6 = Saturday
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return false;
            }
            // Check if it's a holiday
            if (isHoliday(date)) {
                return false;
            }
            return true;
        }

        // Calculate SLA_CUT_OFF with holiday exclusion
        function calculateSlaCutOff(issueDate, rmaCenter, shippingType, productCategory) {
            if (!issueDate) return '';
            
            const indiaDate = convertTaiwanToIndia(issueDate);
            if (!indiaDate || isNaN(indiaDate.getTime())) return '';
            
            const slaDate = new Date(indiaDate);
            const dayOfWeek = slaDate.getDay();
            const parsedShippingType = parseShippingType(shippingType);
            const isSpecialRma = specialRmaCenters.includes(rmaCenter);
            
            let workdays;
            
            if (productCategory === 'Consumer') {
                if (isSpecialRma) {
                    workdays = parsedShippingType === "On site" ? 7 : 5;
                } else {
                    workdays = parsedShippingType === "On site" ? 5 : 3;
                }
            } else {
                if (isSpecialRma) {
                    workdays = parsedShippingType === "On site" ? 5 : 3;
                } else {
                    workdays = 3;
                }
            }
            
            if (dayOfWeek === 5 || dayOfWeek === 6) {
                let daysToMonday;
                if (dayOfWeek === 5) {
                    daysToMonday = 3;
                } else {
                    daysToMonday = 2;
                }
                
                slaDate.setDate(slaDate.getDate() + daysToMonday);
                
                // Count Monday only if it is a working day
                let remainingDays = workdays;
                if (isWorkingDay(slaDate)) {
                    remainingDays -= 1;
                }
                
                while (remainingDays > 0) {
                    slaDate.setDate(slaDate.getDate() + 1);
                    if (isWorkingDay(slaDate)) {
                        remainingDays--;
                    }
                }
            } else {
                let addedDays = 0;
                while (addedDays < workdays) {
                    slaDate.setDate(slaDate.getDate() + 1);
                    if (isWorkingDay(slaDate)) {
                        addedDays++;
                    }
                }
            }
            
            slaDate.setMinutes(slaDate.getMinutes() - 1);
            return formatDate(slaDate);
        }

        // Format date
        function formatDate(date) {
            if (!date || isNaN(date.getTime())) return '';
            
            const formattedDate = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            
            const formattedTime = date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            
            return `${formattedDate} ${formattedTime}`;
        }

        // Calculate TAT_STATUS using RMA_SHIP_DATE (converted to India time)
        function calculateTatStatus(shipDate, slaCutOff) {
            if (!shipDate || !slaCutOff) return 'NOT_SHIPPED';
            
            const shipDateIndia = convertTaiwanToIndia(shipDate);
            const slaDateObj = parseDateString(slaCutOff);
            
            if (!shipDateIndia || !slaDateObj || isNaN(shipDateIndia.getTime()) || isNaN(slaDateObj.getTime())) {
                return 'INVALID_DATE';
            }
            
            return shipDateIndia <= slaDateObj ? 'Within-TAT' : 'Out-TAT';
        }

        // Generate summary table for a dataset
        function generateSummaryTable(data, tableBodyId) {
            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = '';
            
            const centerGroups = {};
            data.forEach(row => {
                const center = row.RMA_CENTER || 'Unknown';
                if (!centerGroups[center]) {
                    centerGroups[center] = {
                        outTat: 0,
                        withinTat: 0,
                        notShipped: 0,
                        invalidDate: 0
                    };
                }
                
                if (row.TAT_STATUS === 'Out-TAT') centerGroups[center].outTat++;
                else if (row.TAT_STATUS === 'Within-TAT') centerGroups[center].withinTat++;
                else if (row.TAT_STATUS === 'NOT_SHIPPED') centerGroups[center].notShipped++;
                else centerGroups[center].invalidDate++;
            });
            
            const sortedCenters = Object.keys(centerGroups).sort();
            
            let totalOutTat = 0;
            let totalWithinTat = 0;
            let totalGrandTotal = 0;
            let totalNotShipped = 0;
            
            sortedCenters.forEach(center => {
                const group = centerGroups[center];
                const outTat = group.outTat;
                const withinTat = group.withinTat;
                const notShipped = group.notShipped;
                const grandTotal = outTat + withinTat;
                const percentage = grandTotal > 0 ? ((withinTat / grandTotal) * 100).toFixed(0) : 0;
                
                totalOutTat += outTat;
                totalWithinTat += withinTat;
                totalGrandTotal += grandTotal;
                totalNotShipped += notShipped;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${center}</td>
                    <td>${outTat}</td>
                    <td>${withinTat}</td>
                    <td>${grandTotal}${notShipped > 0 ? ` (+${notShipped} not shipped)` : ''}</td>
                    <td>${percentage}%</td>
                `;
                tableBody.appendChild(tr);
            });
            
            const totalPercentage = totalGrandTotal > 0 ? ((totalWithinTat / totalGrandTotal) * 100).toFixed(0) : 0;
            const totalTr = document.createElement('tr');
            totalTr.style.fontWeight = 'bold';
            totalTr.style.backgroundColor = 'var(--light-color)';
            totalTr.innerHTML = `
                <td>Grand Total</td>
                <td>${totalOutTat}</td>
                <td>${totalWithinTat}</td>
                <td>${totalGrandTotal}${totalNotShipped > 0 ? ` (+${totalNotShipped} not shipped)` : ''}</td>
                <td>${totalPercentage}%</td>
            `;
            tableBody.appendChild(totalTr);
            
            return {
                totalOutTat,
                totalWithinTat,
                totalGrandTotal,
                totalNotShipped,
                totalPercentage
            };
        }

        // Generate detailed table
        function generateDetailedTable(data, headerId, bodyId) {
            const header = document.getElementById(headerId);
            const body = document.getElementById(bodyId);
            
            header.innerHTML = '';
            body.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            const displayColumns = [
                'RMA_CENTER', 'RMA_NO', 'RMA_SHIPPING_TYPE_DESC', 'RMA_SERIAL_NO',
                'RMA_REPAIR_SOLUTION_MEMO', 'RMA_ISSUE_DATE', 'RMA_SHIP_DATE', 'RMA_CLOSED_DATE',
                'SLA_CUT_OFF', 'TAT_STATUS', 'PRODUCT_CATEGORY', 'RMA_PRODUCT_TYPE_DESC'
            ];
            
            displayColumns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
            });
            header.appendChild(headerRow);
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                
                if (row.TAT_STATUS === 'Within-TAT') {
                    tr.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
                } else if (row.TAT_STATUS === 'Out-TAT') {
                    tr.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
                } else if (row.TAT_STATUS === 'NOT_SHIPPED') {
                    tr.style.backgroundColor = 'rgba(243, 156, 18, 0.1)';
                }
                
                if (row.PRODUCT_CATEGORY === 'Commercial') {
                    tr.classList.add('commercial-highlight');
                }
                
                displayColumns.forEach(column => {
                    const td = document.createElement('td');
                    
                    if (column === 'RMA_SHIPPING_TYPE_DESC') {
                        td.textContent = parseShippingType(row[column]) || row[column] || '';
                        td.title = `Original: ${row[column] || ''}`;
                    } else if (column === 'RMA_ISSUE_DATE') {
                        td.textContent = row.ISSUE_DATE_INDIA || row[column] || '';
                        td.title = `Taiwan: ${row.ORIGINAL_ISSUE_DATE || ''}\nIndia: ${row.ISSUE_DATE_INDIA || 'N/A'}`;
                    } else if (column === 'RMA_SHIP_DATE') {
                        td.textContent = row.SHIP_DATE_INDIA || row[column] || '';
                        td.title = `Taiwan: ${row.ORIGINAL_SHIP_DATE || ''}\nIndia: ${row.SHIP_DATE_INDIA || 'N/A'}`;
                    } else if (column === 'RMA_CLOSED_DATE') {
                        td.textContent = row.CLOSED_DATE_INDIA || row[column] || '';
                        td.title = `Taiwan: ${row.ORIGINAL_CLOSED_DATE || ''}\nIndia: ${row.CLOSED_DATE_INDIA || 'N/A'}`;
                    } else {
                        td.textContent = row[column] || '';
                    }
                    
                    if (column === 'TAT_STATUS') {
                        td.style.fontWeight = 'bold';
                        if (row[column] === 'Within-TAT') {
                            td.style.color = 'var(--success-color)';
                        } else if (row[column] === 'Out-TAT') {
                            td.style.color = 'var(--danger-color)';
                        } else if (row[column] === 'NOT_SHIPPED') {
                            td.style.color = 'var(--warning-color)';
                        }
                    }
                    
                    if (column === 'PRODUCT_CATEGORY') {
                        td.style.fontWeight = 'bold';
                        if (row[column] === 'Commercial') {
                            td.style.color = '#9b59b6';
                        }
                    }
                    
                    tr.appendChild(td);
                });
                
                body.appendChild(tr);
            });
        }

        // Display all results
        function displayResults() {
            overallSummary.innerHTML = '';
            
            const overallOutTat = processedData.filter(row => row.TAT_STATUS === 'Out-TAT').length;
            const overallWithinTat = processedData.filter(row => row.TAT_STATUS === 'Within-TAT').length;
            const overallNotShipped = processedData.filter(row => row.TAT_STATUS === 'NOT_SHIPPED').length;
            const overallInvalidDate = processedData.filter(row => row.TAT_STATUS === 'INVALID_DATE').length;
            const overallTotalShipped = overallOutTat + overallWithinTat;
            const overallTotal = processedData.length;
            const overallPercentage = overallTotalShipped > 0 ? ((overallWithinTat / overallTotalShipped) * 100).toFixed(1) : 0;
            
            const consumerOutTat = consumerData.filter(row => row.TAT_STATUS === 'Out-TAT').length;
            const consumerWithinTat = consumerData.filter(row => row.TAT_STATUS === 'Within-TAT').length;
            const consumerNotShipped = consumerData.filter(row => row.TAT_STATUS === 'NOT_SHIPPED').length;
            const consumerTotalShipped = consumerOutTat + consumerWithinTat;
            const consumerTotal = consumerData.length;
            const consumerPercentage = consumerTotalShipped > 0 ? ((consumerWithinTat / consumerTotalShipped) * 100).toFixed(1) : 0;
            
            const commercialOutTat = commercialData.filter(row => row.TAT_STATUS === 'Out-TAT').length;
            const commercialWithinTat = commercialData.filter(row => row.TAT_STATUS === 'Within-TAT').length;
            const commercialNotShipped = commercialData.filter(row => row.TAT_STATUS === 'NOT_SHIPPED').length;
            const commercialTotalShipped = commercialOutTat + commercialWithinTat;
            const commercialTotal = commercialData.length;
            const commercialPercentage = commercialTotalShipped > 0 ? ((commercialWithinTat / commercialTotalShipped) * 100).toFixed(1) : 0;
            
            const summaryCards = [
                { 
                    title: 'Total RMA Calls', 
                    value: overallTotal, 
                    subtitle: `${overallTotalShipped} shipped, ${overallNotShipped} not shipped`,
                    color: 'primary' 
                },
                { 
                    title: 'Within-TAT Shipped', 
                    value: overallWithinTat, 
                    subtitle: `${overallPercentage}% of shipped calls`,
                    color: 'success',
                    extraClass: 'within-tat' 
                },
                { 
                    title: 'Out-TAT Shipped', 
                    value: overallOutTat, 
                    subtitle: `${overallPercentage}% Within-TAT Rate`,
                    color: 'danger',
                    extraClass: 'out-tat' 
                },
                { 
                    title: 'Consumer Shipped', 
                    value: consumerTotalShipped, 
                    subtitle: `${consumerWithinTat} Within-TAT (${consumerPercentage}%)`,
                    color: 'success' 
                },
                { 
                    title: 'Commercial Shipped', 
                    value: commercialTotalShipped, 
                    subtitle: `${commercialWithinTat} Within-TAT (${commercialPercentage}%)`,
                    color: '#9b59b6'
                }
            ];
            
            summaryCards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'summary-card';
                cardElement.innerHTML = `
                    <h3>${card.title}</h3>
                    <div class="summary-value ${card.extraClass || ''}" style="${card.color === '#9b59b6' ? 'color: #9b59b6' : ''}">${card.value}</div>
                    <div style="margin-top: 5px; font-size: 0.9rem; color: #666;">${card.subtitle}</div>
                `;
                overallSummary.appendChild(cardElement);
            });
            
            generateSummaryTable(processedData, 'overallTableBody');
            generateSummaryTable(consumerData, 'consumerTableBody');
            generateSummaryTable(commercialData, 'commercialTableBody');
            
            generateDetailedTable(processedData, 'overallDetailedHeader', 'overallDetailedBody');
            generateDetailedTable(consumerData, 'consumerDetailedHeader', 'consumerDetailedBody');
            generateDetailedTable(commercialData, 'commercialDetailedHeader', 'commercialDetailedBody');
            
            // Show holiday summary if holidays exist
            if (holidays.size > 0) {
                holidaySummary.style.display = 'block';
                holidayCount.textContent = holidays.size;
            }
        }

        // Export all data to CSV
        function exportAllToCsv() {
            if (processedData.length === 0) {
                showStatus('No data to export.', 'error');
                return;
            }
            
            const headers = [
                'RMA_CENTER', 'RMA_NO', 'RMA_SHIPPING_TYPE_DESC', 'RMA_SERIAL_NO',
                'RMA_REPAIR_SOLUTION_MEMO', 'RMA_ISSUE_DATE', 'RMA_SHIP_DATE', 'RMA_CLOSED_DATE',
                'SLA_CUT_OFF', 'TAT_STATUS', 'PRODUCT_CATEGORY', 'RMA_PRODUCT_TYPE_DESC',
                'ISSUE_DATE_INDIA', 'SHIP_DATE_INDIA', 'CLOSED_DATE_INDIA'
            ];
            
            const csvContent = [
                headers.join(','),
                ...processedData.map(row => 
                    headers.map(header => 
                        `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                    ).join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, 'rma_tat_analysis_all.csv');
            showStatus('All data exported to CSV successfully!', 'success');
        }

        // Export all data to Excel with multiple sheets
        function exportAllToXlsx() {
            if (processedData.length === 0) {
                showStatus('No data to export.', 'error');
                return;
            }
            
            const workbook = XLSX.utils.book_new();
            
            const overallHeaders = [
                'RMA_CENTER', 'RMA_NO', 'RMA_SHIPPING_TYPE_DESC', 'RMA_SERIAL_NO',
                'RMA_REPAIR_SOLUTION_MEMO', 'RMA_ISSUE_DATE', 'RMA_SHIP_DATE', 'RMA_CLOSED_DATE',
                'SLA_CUT_OFF', 'TAT_STATUS', 'PRODUCT_CATEGORY', 'RMA_PRODUCT_TYPE_DESC',
                'ISSUE_DATE_INDIA', 'SHIP_DATE_INDIA', 'CLOSED_DATE_INDIA'
            ];
            
            const overallWorksheet = XLSX.utils.json_to_sheet(processedData, { header: overallHeaders });
            XLSX.utils.book_append_sheet(workbook, overallWorksheet, 'Overall');
            
            const consumerWorksheet = XLSX.utils.json_to_sheet(consumerData, { header: overallHeaders });
            XLSX.utils.book_append_sheet(workbook, consumerWorksheet, 'Consumer');
            
            const commercialWorksheet = XLSX.utils.json_to_sheet(commercialData, { header: overallHeaders });
            XLSX.utils.book_append_sheet(workbook, commercialWorksheet, 'Commercial');
            
            // Add holiday sheet if holidays exist
            if (holidays.size > 0) {
                const holidayData = Array.from(holidays).map(date => ({ Holiday_Date: date }));
                const holidayWorksheet = XLSX.utils.json_to_sheet(holidayData);
                XLSX.utils.book_append_sheet(workbook, holidayWorksheet, 'Holidays');
            }
            
            XLSX.writeFile(workbook, 'rma_tat_analysis_all.xlsx');
            showStatus('All data exported to Excel successfully!', 'success');
        }

        // Export specific category to CSV
        function exportCategoryToCsv(category) {
            let data;
            let filename;
            
            switch(category) {
                case 'overall':
                    data = processedData;
                    filename = 'rma_tat_overall.csv';
                    break;
                case 'consumer':
                    data = consumerData;
                    filename = 'rma_tat_consumer.csv';
                    break;
                case 'commercial':
                    data = commercialData;
                    filename = 'rma_tat_commercial.csv';
                    break;
                default:
                    return;
            }
            
            if (data.length === 0) {
                showStatus(`No ${category} data to export.`, 'error');
                return;
            }
            
            const headers = [
                'RMA_CENTER', 'RMA_NO', 'RMA_SHIPPING_TYPE_DESC', 'RMA_SERIAL_NO',
                'RMA_REPAIR_SOLUTION_MEMO', 'RMA_ISSUE_DATE', 'RMA_SHIP_DATE', 'RMA_CLOSED_DATE',
                'SLA_CUT_OFF', 'TAT_STATUS', 'PRODUCT_CATEGORY', 'RMA_PRODUCT_TYPE_DESC',
                'ISSUE_DATE_INDIA', 'SHIP_DATE_INDIA', 'CLOSED_DATE_INDIA'
            ];
            
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => 
                        `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                    ).join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, filename);
            showStatus(`${category.charAt(0).toUpperCase() + category.slice(1)} data exported to CSV successfully!`, 'success');
        }

        // Reset application
        function resetApp() {
            fileInput.value = '';
            holidayFileInput.value = '';
            uploadedData = [];
            processedData = [];
            consumerData = [];
            commercialData = [];
            holidays.clear();
            
            resultsSection.style.display = 'none';
            uploadStatus.classList.add('hidden');
            holidayStatus.classList.add('hidden');
            holidayListContainer.style.display = 'none';
            holidaySummary.style.display = 'none';
            
            overallSummary.innerHTML = '';
            
            ['overallTableBody', 'consumerTableBody', 'commercialTableBody', 
             'overallDetailedBody', 'consumerDetailedBody', 'commercialDetailedBody'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '';
            });
            
            ['overallDetailedHeader', 'consumerDetailedHeader', 'commercialDetailedHeader'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '';
            });
            
            categoryTabs.forEach(tab => tab.classList.remove('active'));
            categoryContents.forEach(content => content.classList.remove('active'));
            categoryTabs[0].classList.add('active');
            categoryContents[0].classList.add('active');
        }

        // Show status message
        function showStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = `status-message ${type}`;
            uploadStatus.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    uploadStatus.classList.add('hidden');
                }, 5000);
            }
        }
    </script>
</body>
</html>